name: Build and Deploy Stock Clustering Container

on:
  push:
    branches: [ main ]
    paths:
      - 'Dockerfile'
      - 'requirements.txt'
      - 'app.py'
      - 'build_data_mock.py'
      - 'database_manager.py'
  pull_request:
    branches: [ main ]
    paths:
      - 'Dockerfile'
      - 'requirements.txt'
      - 'app.py'
      - 'build_data_mock.py'
      - 'database_manager.py'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: Extract metadata
      id: meta
      run: |
        echo "timestamp=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT
        echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT
        echo "branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
        
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/stock-clustering:latest
          ${{ secrets.DOCKER_USERNAME }}/stock-clustering:${{ steps.meta.outputs.timestamp }}
          ${{ secrets.DOCKER_USERNAME }}/stock-clustering:${{ steps.meta.outputs.sha }}
        labels: |
          org.opencontainers.image.title=Stock Clustering Demo
          org.opencontainers.image.description=Interactive stock clustering dashboard with pre-computed analysis
          org.opencontainers.image.source=https://github.com/${{ github.repository }}
          org.opencontainers.image.version=${{ steps.meta.outputs.sha }}
          org.opencontainers.image.created=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          org.opencontainers.image.revision=${{ steps.meta.outputs.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Generate deployment manifest
      run: |
        cat > deployment-manifest.json << EOF
        {
          "image": "${{ secrets.DOCKER_USERNAME }}/stock-clustering:latest",
          "tag": "latest",
          "sha": "${{ steps.meta.outputs.sha }}",
          "timestamp": "${{ steps.meta.outputs.timestamp }}",
          "branch": "${{ steps.meta.outputs.branch }}",
          "build_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
          "registry": "https://hub.docker.com/r/${{ secrets.DOCKER_USERNAME }}/stock-clustering",
          "size": "Lightweight (~200MB)",
          "platforms": ["linux/amd64", "linux/arm64"],
          "features": [
            "Interactive dashboard",
            "Pre-computed clustering analysis",
            "15 diversified stocks",
            "5 years of historical data",
            "6 technical features per stock",
            "Optimal K-means clustering",
            "SQLite embedded database",
            "Zero configuration deployment"
          ],
          "quick_start": {
            "command": "docker run -p 8501:8501 ${{ secrets.DOCKER_USERNAME }}/stock-clustering:latest",
            "url": "http://localhost:8501",
            "description": "Access interactive stock clustering dashboard"
          },
          "requirements": {
            "docker": "20.10+",
            "memory": "2GB+ recommended",
            "ports": ["8501:8501"]
          }
        }
        EOF
        
    - name: Upload deployment manifest
      uses: actions/upload-artifact@v4
      with:
        name: deployment-manifest
        path: deployment-manifest.json
        
    - name: Create Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: actions/create-release@v4
      with:
        name: Release ${{ steps.meta.outputs.timestamp }}
        tag: v${{ steps.meta.outputs.timestamp }}
        body: |
          ## ğŸ³ Stock Clustering Demo Container Release
          
          ### ğŸš€ Quick Start
          ```bash
          docker run -p 8501:8501 ${{ secrets.DOCKER_USERNAME }}/stock-clustering:latest
          # Visit: http://localhost:8501
          ```
          
          ### ğŸ“Š What's Included
          - âœ… Interactive stock clustering dashboard
          - âœ… 15 diversified stocks with 5 years of data  
          - âœ… 6 technical features per stock
          - âœ… Optimal K-means clustering with automatic detection
          - âœ… SQLite embedded database (zero configuration)
          - âœ… Professional Plotly visualizations
          
          ### ğŸ—ï¸ Architecture
          - **Base**: Python 3.11 slim
          - **Frontend**: Streamlit with Plotly
          - **ML**: Scikit-learn KMeans clustering
          - **Database**: SQLite with pre-computed results
          - **Platforms**: linux/amd64, linux/arm64
          
          ### ğŸ”§ Container Information
          - **Image**: ${{ secrets.DOCKER_USERNAME }}/stock-clustering:${{ steps.meta.outputs.sha }}
          - **Size**: ~200MB
          - **Build**: [View Build Workflow](${{ steps.meta.outputs.build_url }})
          - **Registry**: [Docker Hub](${{ secrets.DOCKER_USERNAME }}/stock-clustering)
          
          ---
          
          ğŸ³ **Built with â¤ï¸ using GitHub Actions**
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Security scan job
  security-scan:
    runs-on: ubuntu-latest
    needs: build-and-deploy
    steps:
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'docker.io/${{ secrets.DOCKER_USERNAME }}/stock-clustering:latest'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  # Test container deployment
  test-deployment:
    runs-on: ubuntu-latest
    needs: build-and-deploy
    steps:
    - name: Test container
      run: |
        echo "ğŸ§ª Testing container deployment..."
        
        # Pull and run the newly built image
        docker run -d --name test-container -p 8502:8501 \
          ${{ secrets.DOCKER_USERNAME }}/stock-clustering:latest
          
        # Wait for container to start
        sleep 30
        
        # Test if the application is responding
        if curl -f http://localhost:8502/_stcore/health; then
          echo "âœ… Container health check passed"
          
          # Test dashboard accessibility
          if curl -s http://localhost:8502 > /dev/null; then
            echo "âœ… Dashboard is accessible"
            
            # Get container logs for verification
            echo "ğŸ“‹ Container startup logs:"
            docker logs test-container | head -20
          else
            echo "âŒ Dashboard not accessible"
            exit 1
        else
          echo "âŒ Container health check failed"
          docker logs test-container
          exit 1
          
        # Cleanup
        docker stop test-container
        docker rm test-container
        
        echo "ğŸ§ª Container testing completed successfully"
      env:
        DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}

# Notification job
  notify:
    runs-on: ubuntu-latest
    needs: [build-and-deploy, test-deployment]
    if: always()
    steps:
    - name: Send notification
      run: |
        if [ "${{ needs.build-and-deploy.result }}" == "success" ] && [ "${{ needs.test-deployment.result }}" == "success" ]; then
          echo "ğŸ‰ Stock Clustering container built and deployed successfully!"
          echo "ğŸ“Š Image: ${{ secrets.DOCKER_USERNAME }}/stock-clustering:latest"
          echo "ğŸ”— Quick start: docker run -p 8501:8501 ${{ secrets.DOCKER_USERNAME }}/stock-clustering:latest"
        else
          echo "âŒ Build or deployment failed"
          echo "ğŸ” Check workflow logs for details"
        fi